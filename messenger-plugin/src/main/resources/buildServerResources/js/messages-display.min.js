var j=jQuery,md={action:null,messageLengthLimit:null,titleTemplate:new Template('Message "#{id}", sent by #{senderName} on #{date} at #{time}'),messageDisplayed:-1,messages:[],nMessages:function(){return md.messages.length},dialog:function(a){a=j.extend({statusMessage:!1,urgency:""},a);j.assert(a.title,"dialog(): 'options.title' is not specified");j.assert(a.text,"dialog(): 'options.text' is not specified");md.dialogClose();a.statusMessage?(j("#messages-display-dialog-buttons").hide(),j("#messages-display-dialog-text").css({"margin-top":"30px",
"text-align":"center"})):(j("#messages-display-dialog-buttons").show(),j("#messages-display-dialog-text").css({"margin-top":"2px","text-align":"left"}));j("#messages-display-dialog-text").text(a.text);j("#messages-display-dialog").dialog({height:115,width:490,position:"top",title:a.title,close:md.dialogClose});a.urgency?j("div.ui-widget-header").addClass("dialog-"+a.urgency):j("div.ui-widget-header").removeClass("dialog-info").removeClass("dialog-warning").removeClass("dialog-critical")},isDeleted:function(a){return j.choose(a.deleted,
!1)},unknownMessage:function(a){return!md.messages.contains(function(b){return b.id==a.id})},dialogMessage:function(){j.assert(md.messageDisplayed>-1&&md.messageDisplayed<md.nMessages(),"dialogMessage(): ["+md.messageDisplayed+"]["+md.nMessages()+"] (md.messageDisplayed, md.nMessages())");var a=md.messages[md.messageDisplayed];j.assert(!a.deleted,"dialogMessage(): ["+md.messageDisplayed+"]["+a.id+"] (md.messageDisplayed, message.id - deleted)");var b=md.messages.count(md.isDeleted,0,md.messageDisplayed),
d=md.messages.count(md.isDeleted,md.messageDisplayed+1),c=md.messageDisplayed+1-b,b=md.nMessages()-b-d;j.assert(c>0,"dialogMessage(): ["+c+"] (counter)");j.assert(b>0,"dialogMessage(): ["+b+"] (total)");j.assert(c<=b,"dialogMessage(): ["+c+"]["+b+"] (counter, total)");j.assert(b<=md.nMessages(),"dialogMessage(): ["+b+"]["+md.nMessages()+"] (total, md.nMessages())");j("#messages-display-counter").text(c);j("#messages-display-counter-total").text(b);j("#messages-display-dialog-prev").enable(c>1);j("#messages-display-dialog-next").enable(c<
b);md.dialog({title:md.titleTemplate.evaluate(a),text:a.text,urgency:a.urgency})},getMessages:function(){j.get(md.action,{t:j.now()},function(a){if(a&&a.length){if(md.nMessages()<1||md.nMessages()!=a.length||a.any(md.unknownMessage))md.messageDisplayed=0,md.messages=a.slice(0),j.assert(md.nMessages(),"getMessages(): ["+md.nMessages()+"] (md.nMessages())"),md.dialogMessage()}else md.dialogClose()},"json")},prevMessage:function(){j.assert(md.messageDisplayed>0,'"Prev" click: ['+md.messageDisplayed+
"] (md.messageDisplayed)");var a;for(a=md.messageDisplayed-1;md.messages[a].deleted;a--);j.assert(a>-1&&a<md.messageDisplayed,'"Prev" click: ['+a+"]["+md.messageDisplayed+"] (prevMessage, md.messageDisplayed)");md.messageDisplayed=a;md.dialogMessage();return!1},nextMessage:function(){j.assert(md.messageDisplayed<md.nMessages()-1,'"Next" click: ['+md.messageDisplayed+"]["+md.nMessages()+"] (md.messageDisplayed, md.nMessages())");var a;for(a=md.messageDisplayed+1;md.messages[a].deleted;a++);j.assert(a<
md.nMessages()&&a>md.messageDisplayed,'"Next" click: ['+a+"]["+md.messageDisplayed+"] (nextMessage, md.messageDisplayed)");md.messageDisplayed=a;md.dialogMessage();return!1},dialogClose:function(){j("#messages-display-dialog").dialog("destroy");return!1},deleteMessage:function(){j("#messages-display-progress").show();j.assert(md.messageDisplayed>-1&&md.messageDisplayed<md.nMessages(),'"Delete" click: ['+md.messageDisplayed+"] (md.messageDisplayed)");var a=md.messages[md.messageDisplayed];j.ajax({url:md.action,
type:"POST",data:{id:a.id},dataType:"text",success:function(b){j.assert(a.id==b,'"Delete" click: ['+a.id+"] != ["+b+"]");a.deleted=!0;md.dialog({title:"Message Deleted",text:'Message "'+b+'" deleted',statusMessage:!0});(function(){var a=md.messages.newIndexOf(md.isDeleted,!0,md.messageDisplayed+1);a<0&&(a=md.messages.newIndexOf(md.isDeleted,!0,0,md.messageDisplayed));a<0?md.dialogClose():(md.messageDisplayed=a,md.dialogMessage())}).delay(1)},error:function(){md.dialog({title:"Message not Deleted",
text:'Failed to delete message "'+messageId+'"',statusMessage:!0,urgency:"critical"})},complete:function(){j("#messages-display-progress").hide()}});return!1}};j(function(){j("#messages-display-dialog-prev").click(md.prevMessage);j("#messages-display-dialog-next").click(md.nextMessage);j("#messages-display-dialog-close").click(md.dialogClose);j("#messages-display-dialog-delete").click(md.deleteMessage)});