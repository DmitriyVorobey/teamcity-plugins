var md;
(function(b){md={action:null,titleTemplate:new Template('Message "#{id}", sent by #{senderName} on #{date} at #{time}'),messageDisplayed:-1,messages:[],nMessages:function(){return md.messages.length},dialogOpen:function(a){a=b.extend({statusMessage:!1,urgency:""},a);b.assert(a.title,"dialog(): 'options.title' is not specified");b.assert(a.text,"dialog(): 'options.text' is not specified");md.dialogClose();a.statusMessage?(b("#messages-display-dialog-buttons").hide(),b("#messages-display-dialog-text").css({"margin-top":"30px","text-align":"center"})):
(b("#messages-display-dialog-buttons").show(),b("#messages-display-dialog-text").css({"margin-top":"2px","text-align":"left"}));b("#messages-display-dialog-text").text(a.text);b("#messages-display-dialog").dialog({title:a.title.escapeHTML()}).dialog("open");b("div.ui-widget-header").removeClass("dialog-info").removeClass("dialog-warning").removeClass("dialog-critical");a.urgency&&b("div.ui-widget-header").addClass("dialog-"+a.urgency)},dialogClose:function(){b("#messages-display-dialog").dialog("close");
return!1},isDeleted:function(a){return b.choose(a.deleted,!1)},unknownMessage:function(a){return!md.messages.contains(function(b){return b.id==a.id})},dialogOpenMessage:function(){b.assert(md.messageDisplayed>-1&&md.messageDisplayed<md.nMessages(),"dialogOpenMessage(): ["+md.messageDisplayed+"]["+md.nMessages()+"] (md.messageDisplayed, md.nMessages())");var a=md.messages[md.messageDisplayed];b.assert(!a.deleted,"dialogOpenMessage(): ["+md.messageDisplayed+"]["+a.id+"] (md.messageDisplayed, message.id - deleted)");
var c=md.messages.count(md.isDeleted,0,md.messageDisplayed),e=md.messages.count(md.isDeleted,md.messageDisplayed+1),d=md.messageDisplayed+1-c,c=md.nMessages()-c-e;b.assert(d>0,"dialogOpenMessage(): ["+d+"] (counter)");b.assert(c>0,"dialogOpenMessage(): ["+c+"] (total)");b.assert(d<=c,"dialogOpenMessage(): ["+d+"]["+c+"] (counter, total)");b.assert(c<=md.nMessages(),"dialogOpenMessage(): ["+c+"]["+md.nMessages()+"] (total, md.nMessages())");b("#messages-display-counter").text(d);b("#messages-display-counter-total").text(c);
b("#messages-display-dialog-prev").enable(d>1);b("#messages-display-dialog-next").enable(d<c);md.dialogOpen({title:md.titleTemplate.evaluate(a),text:a.text,urgency:a.urgency})},getMessages:function(){b.get(md.action,{t:b.now()},function(a){if(a&&a.length){if(md.nMessages()<1||md.nMessages()!=a.length||a.any(md.unknownMessage))md.messageDisplayed=0,md.messages=a.slice(0),b.assert(md.nMessages(),"getMessages(): ["+md.nMessages()+"] (md.nMessages())"),md.dialogOpenMessage()}else md.dialogClose()},"json")},
prevMessage:function(){if(md.messageDisplayed>0){var a;for(a=md.messageDisplayed-1;md.messages[a].deleted;a--);b.assert(a>-1&&a<md.messageDisplayed,'"Prev" click: ['+a+"]["+md.messageDisplayed+"] (prevMessage, md.messageDisplayed)");md.messageDisplayed=a;md.dialogOpenMessage()}return!1},nextMessage:function(){if(md.messageDisplayed<md.nMessages()-1){var a;for(a=md.messageDisplayed+1;md.messages[a].deleted;a++);b.assert(a<md.nMessages()&&a>md.messageDisplayed,'"Next" click: ['+a+"]["+md.messageDisplayed+
"] (nextMessage, md.messageDisplayed)");md.messageDisplayed=a;md.dialogOpenMessage()}return!1},deleteMessage:function(){b("#messages-display-progress").show();b.assert(md.messageDisplayed>-1&&md.messageDisplayed<md.nMessages(),'"Delete" click: ['+md.messageDisplayed+"] (md.messageDisplayed)");var a=md.messages[md.messageDisplayed];b.ajax({url:md.action,type:"POST",data:{id:a.id},dataType:"text",success:function(c){c&&b.assert(a.id==c,'"Delete" click: ['+a.id+"] != ["+c+"]");a.deleted=!0;md.dialogOpen({title:"Message Deleted",
text:'Message "'+a.id+'" '+(c?"deleted":"was already deleted"),statusMessage:!0});(function(){var a=md.messages.newIndexOf(md.isDeleted,!0,md.messageDisplayed+1);a<0&&(a=md.messages.newIndexOf(md.isDeleted,!0,0,md.messageDisplayed));a<0?md.dialogClose():(md.messageDisplayed=a,md.dialogOpenMessage())}).delay(1)},error:function(){md.dialogOpen({title:"Message not Deleted",text:'Failed to delete message "'+messageId+'"',statusMessage:!0,urgency:"critical"})},complete:function(){b("#messages-display-progress").hide()}});
return!1}};b(function(){b("#messages-display-dialog").dialog({autoOpen:!1,height:messages_const.dialog_height,width:messages_const.dialog_width,position:"top"});b("#messages-display-dialog-prev").click(md.prevMessage);b("#messages-display-dialog-next").click(md.nextMessage);b("#messages-display-dialog-close").click(md.dialogClose);b("#messages-display-dialog-delete").click(md.deleteMessage);b("body").keydown(function(a){b("#messages-display-dialog").dialog("isOpen")&&(a.which==37&&b("#messages-display-dialog-prev").click(),
a.which==39&&b("#messages-display-dialog-next").click(),a.which==46&&b("#messages-display-dialog-delete").click())})})})(jQuery.noConflict());